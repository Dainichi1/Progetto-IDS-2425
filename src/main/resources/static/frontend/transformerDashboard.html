<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Trasformatore</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .hidden { display: none; }
        #createProductForm { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; }
        label { display: block; margin: 10px 0 5px; }
        input[type="text"], input[type="number"], input[type="file"] { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background-color: #4CAF50; color: white; }
        .btn-secondary { background-color: #f44336; color: white; }
    </style>
</head>
<body>
<h1 id="welcomeMessage">Benvenuto, Trasformatore</h1>
<p>Gestisci i tuoi prodotti qui.</p>

<button id="createProductButton" class="btn-primary">Crea Prodotto</button>
<button id="refreshProducts" class="btn-primary">Aggiorna Prodotti</button>

<div id="createProductForm" class="hidden">
    <h2>Crea un nuovo Prodotto</h2>
    <form id="productForm">
        <label for="productName">Nome del prodotto:</label>
        <input type="text" id="productName" name="name" required>
        <label for="productPrice">Prezzo:</label>
        <input type="number" id="productPrice" name="price" step="0.01" required>
        <label for="productCategory">Categoria:</label>
        <input type="text" id="productCategory" name="category" required>
        <label for="productInfo">Info:</label>
        <input type="text" id="productInfo" name="info" required>
        <label for="productAvailability">Quantità disponibile:</label>
        <input type="number" id="productAvailability" name="availability" required>
        <label for="productImages">Immagine del prodotto:</label>
        <input type="file" id="productImages" name="images" accept="image/*">
        <label for="productCertificato">Certificato:</label>
        <input type="hidden" name="staff" value="TRASFORMATORE">
        <input type="file" id="productCertificato" name="certificato" accept=".pdf,.doc,.docx">
        <button type="button" id="submitForApproval" class="btn-primary">Invia al Curatore</button>
        <button type="button" id="cancelProduct" class="btn-secondary">Annulla</button>
    </form>
</div>

<h2>Elenco Prodotti</h2>
<table id="productsTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Prezzo</th>
        <th>Categoria</th>
        <th>Info</th>
        <th>Quantità</th>
        <th>Immagine</th>
        <th>Certificato</th>
        <th>Stato</th>
        <th>Commenti</th>
        <th>Azione</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const createProductButton = document.getElementById('createProductButton');
        const refreshProductsButton = document.getElementById('refreshProducts');
        const createProductForm = document.getElementById('createProductForm');
        const cancelProductButton = document.getElementById('cancelProduct');
        const submitForApproval = document.getElementById('submitForApproval');

        // Mostra/nasconde il form di creazione prodotto
        createProductButton.addEventListener('click', function () {
            createProductForm.classList.toggle('hidden');
        });
        cancelProductButton.addEventListener('click', function () {
            createProductForm.classList.add('hidden');
            document.getElementById('productForm').reset();
        });

        // Funzione per caricare i prodotti
        function loadProducts() {
            fetch('http://localhost:8080/api/prodotti/trasformatore/rimandati')
                .then(response => response.json())
                .then(prodotti => {
                    const tableBody = document.querySelector('#productsTable tbody');
                    tableBody.innerHTML = '';

                    prodotti.forEach(prodotto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                    <td>${prodotto.id}</td>
                    <td contenteditable="true" data-field="name">${prodotto.name}</td>
                    <td contenteditable="true" data-field="price">${prodotto.price.toFixed(2)}</td>
                    <td contenteditable="true" data-field="category">${prodotto.category}</td>
                    <td contenteditable="true" data-field="info">${prodotto.info}</td>
                    <td contenteditable="true" data-field="availability">${prodotto.availability}</td>
                    <td>
                        <img
                            src="http://localhost:8080/${prodotto.images}"
                            alt="Immagine del prodotto"
                            style="width: 100px; height: auto;"
                        />
                        <br>
                        <input type="file" data-id="${prodotto.id}" data-field="images" accept="image/*" />
                    </td>
                    <td>
                        <a
                            href="http://localhost:8080/${prodotto.certificato}"
                            target="_blank"
                            rel="noopener noreferrer">
                            Certificato
                        </a>
                        <br>
                        <input type="file" data-id="${prodotto.id}" data-field="certificato" accept=".pdf,.doc,.docx" />
                    </td>
                    <td>${prodotto.stato}</td>
                    <td>${prodotto.curatorComments || 'Nessun commento'}</td>
                    <td>
                        <button class="btn-save" data-id="${prodotto.id}">Salva Modifiche</button>
                        <button class="btn-resend" data-id="${prodotto.id}">Rinvia</button>
                    </td>
                `;
                        tableBody.appendChild(row);
                    });

                    attachSaveListeners();
                    attachResendListeners();
                })
                .catch(error => console.error(error));
        }

        function attachSaveListeners() {
            document.querySelectorAll('.btn-save').forEach(button => {
                button.addEventListener('click', function () {
                    const prodottoId = this.getAttribute('data-id');
                    const row = this.closest('tr');

                    // Raccolta dei dati modificabili
                    const updatedData = {};
                    row.querySelectorAll('[contenteditable="true"]').forEach(cell => {
                        const field = cell.getAttribute('data-field');
                        const value = cell.innerText.trim();
                        updatedData[field] = value;
                    });

                    // Raccolta dei nuovi file
                    const formData = new FormData();
                    formData.append('id', prodottoId);

                    row.querySelectorAll('input[type="file"]').forEach(input => {
                        const field = input.getAttribute('data-field');
                        if (input.files.length > 0) {
                            formData.append(field, input.files[0]);
                        }
                    });

                    // Aggiunta dei campi modificabili
                    Object.keys(updatedData).forEach(key => {
                        formData.append(key, updatedData[key]);
                    });

                    // Effettua la richiesta per aggiornare il prodotto
                    fetch(`http://localhost:8080/api/prodotti/trasformatore/update`, {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.text())
                        .then(result => {
                            alert('Prodotto aggiornato con successo.');
                            loadProducts(); // Ricarica i prodotti
                        })
                        .catch(error => {
                            console.error('Errore:', error);
                            alert('Errore durante l\'aggiornamento del prodotto.');
                        });
                });
            });
        }

        function attachResendListeners() {
            document.querySelectorAll('.btn-resend').forEach(button => {
                button.addEventListener('click', function () {
                    const prodottoId = this.getAttribute('data-id');

                    fetch('http://localhost:8080/api/prodotti/trasformatore/resend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prodottoId: prodottoId })
                    })
                        .then(response => response.text())
                        .then(result => {
                            alert(result);
                            loadProducts(); // Aggiorna i prodotti
                        })
                        .catch(error => {
                            console.error(error);
                            alert('Errore durante il rinvio del prodotto.');
                        });
                });
            });
        }

        loadProducts(); // Carica i prodotti all'avvio
        refreshProductsButton.addEventListener('click', loadProducts);

        // Invia un nuovo prodotto
        submitForApproval.addEventListener('click', function () {
            const formData = new FormData(document.getElementById('productForm'));
            fetch('http://localhost:8080/api/prodotti/trasformatore/create', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(result => {
                    alert(result);
                    document.getElementById('productForm').reset();
                    createProductForm.classList.add('hidden');
                    loadProducts();
                })
                .catch(error => console.error(error));
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const params = new URLSearchParams(window.location.search);
        const username = params.get('username');

        if (!username) {
            alert('Errore: username non trovato.');
            return;
        }

        fetch(`http://localhost:8080/api/user/details?username=${username}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nel recupero dei dettagli utente.');
                }
                return response.json();
            })
            .then(userDetails => {
                const welcomeMessage = document.getElementById('welcomeMessage');
                welcomeMessage.textContent = `Benvenuto, Trasformatore (${userDetails.name} ${userDetails.lastname})`;
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore nel caricamento della dashboard.');
            });
    });
</script>
</body>
</html>
